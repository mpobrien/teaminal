{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <script src="/static/socket.io.js"></script>
    <script src="/static/teaminal.js"></script>
    <script>
      var screen, strm, br_screen;
      canvasElem = $('#mycanvas')[0]
      var context;
      Base64Binary = require('./b64binary').Base64Binary

      function feedAll(stream, data){
          for(var i=0;i<data.length;i++){
              stream.feed(data[i])
          }
      }

          

      $(document).ready(function(){
        $('#settings').click(function(){
            $('#myModal').modal()
        });


        socket = io.connect('http://localhost:80/');
        socket.send(JSON.stringify({sid:"abcd"}));
        socket.on("message", function(data){
            console.log("got", data);
            var uintarray = Base64Binary.decode(data)
            console.log(uintarray)
            feedAll(strm, uintarray);
            redraw()
        });

          $(document).keypress(function(e){
              var code = (e.keyCode ? e.keyCode : e.which);
              if(code == 13){
                socket.send('\n');
              }else if(code == 9){
                socket.send('\t');
              }else if(code == 8){
                socket.send('\b');
                return false;
              }else{
                socket.send(String.fromCharCode(e.charCode));
              }
              console.log("keycode", e);
              e.preventDefault();
           }).keydown(function(e){
              var code = (e.keyCode ? e.keyCode : e.which);
              if(code == 8){
                socket.send('\b');
                return false;
              }
           });

        canvasElem = $('#mycanvas')[0];
        context = canvasElem.getContext("2d");
        context.fillStyle = '#fff';
        context.fillRect(0,0,$('#mycanvas').attr('height'),$('#mycanvas').attr('width'));
        context.fillStyle = '#fff'
        //context.font = 'bold 12px monospace';
        context.lineWidth = 2;
        context.fillText("0123456789012345678901234567890123", 0, 16);
        context.fillText("0123456789012345678901234567890123", 0, 32);
        setupTerminal()
        context.fillStyle = '#000'
        redraw()

        $('#styleinput, #fgcolor, #bgcolor').change(function(){
            redraw()
        })
      });

      function setupTerminal(){
          var BasicStream = require('./termstream').BasicStream
          var BasicScreen = require('./screen').BasicScreen
          var BrowserScreen = require('./browserscreen').BrowserScreen
          strm = new BasicStream(); 
          screen = new BasicScreen(40, 80)
          br_screen = new BrowserScreen(screen, context);
          //strm.setDebugMode(true);
          strm.attach(screen)
          //screen.debugMode = true;

          //feedAll(strm, vimtest);
      }

      function redraw(){
        br_screen.clear()
        //br_screen.backgroundColor = $('#bgcolor').val()
        //br_screen.foregroundColor = $('#fgcolor').val()
        context = canvasElem.getContext("2d");
        //context.font = $('#styleinput').val()
        br_screen.canvasDisplay(context)
      }

    </script>
{% endblock %}


{% block navbar %}
    {{ super() }}
    <!--a href="/" class="branding">Teaminal</a-->
    <a href="#" id="settings">Settings</a>
{% endblock %}

{% block content %}
    <canvas id="mycanvas" width="1000" height="600">
    </canvas>

{% include 'fontsettings_modal.html' %}
{% endblock %}


